<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cl.dao.PurchaseMapper">
  <select id="selectPurchaseNumByOrderNo" resultType="java.lang.Integer">
    SELECT
      count(1)
    FROM
      purchase
    WHERE
      order_no = #{orderNo}
    <if test="isAll == 1">
      AND purchase_status in ( 1 , 2)
    </if>
    <if test="isAll == 0">
      AND purchase_status = 2
    </if>
  </select>


  <update id="updatePurchaseStatusByOrderNo" parameterType="string">
    UPDATE purchase
    SET purchase_status = 3
    WHERE order_no = #{orderNo}
    AND purchase_status = 2
  </update>

  <select id="selectOrder" parameterType="string" resultMap="OrderBaseResultMap">
    SELECT
    <include refid="Order_Base_Column_List" />
    FROM
      order_manage
    WHERE
      order_no = #{orderNo}
    AND order_status != 0
  </select>

  <sql id="Order_Base_Column_List">
    id, order_no, order_status, order_quantity, order_time, order_img_url, sku, is_first,
    producer_org_id, producer, surplus_time, purchase_time, tailoring_time, remarks,
    create_time, create_user, last_update_time, last_update_user
  </sql>

  <resultMap id="OrderBaseResultMap" type="com.cl.entity.OrderManageEntity">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="order_no" jdbcType="VARCHAR" property="orderNo" />
    <result column="order_status" jdbcType="TINYINT" property="orderStatus" />
    <result column="order_quantity" jdbcType="INTEGER" property="orderQuantity" />
    <result column="order_time" jdbcType="TIMESTAMP" property="orderTime" />
    <result column="order_img_url" jdbcType="VARCHAR" property="orderImgUrl" />
    <result column="sku" jdbcType="VARCHAR" property="sku" />
    <result column="is_first" jdbcType="TINYINT" property="isFirst" />
    <result column="producer_org_id" jdbcType="BIGINT" property="producerOrgId" />
    <result column="producer" jdbcType="VARCHAR" property="producer" />
    <result column="surplus_time" jdbcType="VARCHAR" property="surplusTime" />
    <result column="purchase_time" jdbcType="INTEGER" property="purchaseTime" />
    <result column="tailoring_time" jdbcType="INTEGER" property="tailoringTime" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="last_update_time" jdbcType="TIMESTAMP" property="lastUpdateTime" />
    <result column="last_update_user" jdbcType="VARCHAR" property="lastUpdateUser" />
  </resultMap>

  <resultMap id="PurchaseResultMap" type="com.cl.entity.PurchaseEntity">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="order_no" jdbcType="VARCHAR" property="orderNo" />
    <result column="purchase_no" jdbcType="VARCHAR" property="purchaseNo" />
    <result column="purchase_time" jdbcType="TIMESTAMP" property="purchaseTime" />
    <result column="supplier_name" jdbcType="VARCHAR" property="supplierName" />
    <result column="supplier_code" jdbcType="VARCHAR" property="supplierCode" />
    <result column="supplier_color_number" jdbcType="VARCHAR" property="supplierColorNumber" />
    <result column="purchase_status" jdbcType="TINYINT" property="purchaseStatus" />
    <result column="materiel_sku" jdbcType="VARCHAR" property="materielSku" />
    <result column="materiel_type_code" jdbcType="VARCHAR" property="materielTypeCode" />
    <result column="materiel_name" jdbcType="VARCHAR" property="materielName" />
    <result column="materiel_color" jdbcType="VARCHAR" property="materielColor" />
    <result column="answer_pick_quantity" jdbcType="INTEGER" property="answerPickQuantity" />
    <result column="answer_pick_monovalent" jdbcType="DECIMAL" property="answerPickMonovalent" />
    <result column="answer_pick_total" jdbcType="DECIMAL" property="answerPickTotal" />
    <result column="actual_pick_quantity" jdbcType="INTEGER" property="actualPickQuantity" />
    <result column="actual_pick_monovalent" jdbcType="DECIMAL" property="actualPickMonovalent" />
    <result column="actual_pick_total" jdbcType="DECIMAL" property="actualPickTotal" />
    <result column="single_amount_kg" jdbcType="DECIMAL" property="singleAmountKg" />
    <result column="consuming_time" jdbcType="DECIMAL" property="consumingTime" />
    <result column="remarks" jdbcType="VARCHAR" property="remarks" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="last_update_time" jdbcType="TIMESTAMP" property="lastUpdateTime" />
    <result column="last_update_user" jdbcType="VARCHAR" property="lastUpdateUser" />
  </resultMap>

  <sql id="Purchase_Column_List">
    id, order_no, purchase_no, purchase_time, supplier_name, supplier_code, supplier_color_number,
    purchase_status, materiel_sku, materiel_type_code, materiel_name, materiel_color,
    answer_pick_quantity, answer_pick_monovalent, answer_pick_total, actual_pick_quantity,
    actual_pick_monovalent, actual_pick_total, single_amount_kg, consuming_time, remarks,
    create_time, create_user, last_update_time, last_update_user
  </sql>

  <select id="selectPurchaseListByOrderNo" parameterType="string" resultMap="PurchaseResultMap">
    SELECT
    <include refid="Purchase_Column_List" />
    FROM
      purchase
    WHERE
      order_no = #{orderNo}
    AND
      purchase_status !=0
    AND
      materiel_type_code = 'fabric'
  </select>

  <select id="selectTailorBySku" resultType="decimal" parameterType="string">
    SELECT
	  t.monovalent
    FROM
        tailor t
    LEFT JOIN order_manage o ON t.order_no = o.order_no
    WHERE
        o.sku = #{sku}
    AND t.status != 0
    AND o.status != 0
    ORDER BY t.create_time DESC
    LIMIT 1
  </select>


</mapper>